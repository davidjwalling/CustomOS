### Project os.007
Source: [os.007/os.asm](../os.007/os.asm)

### Features and Topics
- Using a message queue to route event information to a task.

### [Virtual](VIRTUAL.md) Machine Operation
- Update the Virtual Machine configuration to use os.007/os.dsk as the diskette image.
- Start the Virtual Machine.

<img src="../images/os007_VirtualBox_001.PNG" width="640"/>

### [Physical](PHYSICAL.md) Machine Operation
- Overwrite os.com on the OS boot diskette with os.007/os.com.
- Insert the OS boot diskette into the physical system's floppy disk drive A:.
- Start the system.

<img src="../images/os007_Boot_001.jpg"/>

### Notes

This project updates the Keyboard Interrupt introduced in the past project to send keyboard events to the console task.

First we define new equates for Local Descriptor Table (LDT) and Message Queue values.

<img src="../images/os007_listing_153.PNG"/>

Some additional keyboard scan code equates have been added.

<img src="../images/os007_listing_209.PNG"/>

Symbolic constants have been added for task message queue entries and some message identifiers.

<img src="../images/os007_listing_414.PNG"/>

The MQUEUE structure defines the organization of a message queue storage area. The message queue receives event information from interrupt handlers.

<img src="../images/os007_listing_449.PNG"/>

The Panel Handling section of fields in the console task storage area has a new field added to track the current panel handler. This is the address of the routine to be called to handle events for the panel.

<img src="../images/os007_listing_578.PNG"/>

The Keyboard Interrupt Handler now creates and posts messages to the console task when a key is pressed or released and if a key code maps to a printable ASCII character. Additionally, in a few places (not shown), branches to .putoia now branch to .putmessage or .putkeydown.

<img src="../images/os007_listing_2380.PNG"/>

A new service request, GetConsoleMessage, is added which waits for a message to arrive for the console task.

<img src="../images/os007_listing_2648.PNG"/>

A new service request macro is defined for the GetConsoleMessage service request.

<img src="../images/os007_listing_2662.PNG"/>

The GetConsoleMessage routine is added to the Console Helper Routines section of the kernel.

<img src="../images/os007_listing_2694.PNG"/>

Two new helper routines, GetMessage and PutMessage

<img src="../images/os007_listing_2933.PNG"/><br>
<img src="../images/os007_listing_2941.PNG"/>

Two new routines are added to the console task, ConHandlerMain and ConClearField.

<img src="../images/os007_listing_3298.PNG"/>

In ConCode, after the cursor is placed in the current field, new code is added to get the next key-down message, give it to the panel event handler, and, if the field has a buffer, handle arrow keys, backspace and printables, then redrawing the field.

<img src="../images/os007_listing_3347.PNG"/><br>
<img src="../images/os007_listing_3397.PNG"/>

The ConHandlerMain routine handles events specific to the main panel. Events not handled here may be handled by the generic handler in ConCode.

<img src="../images/os007_listing_3587.PNG"/>

The ConClearField resets a field, usually an input field, by setting its index to zero and the contents of its buffer to zeros.

<img src="../images/os007_listing_3625.PNG"/>

The ConMain routine now initializes the panel handler routine address which is defined in a table of routine offsets.

<img src="../images/os007_listing_3663.PNG"/>
