### Project os.009
Source: [os.009/os.asm](../os.009/os.asm)

### Features and Topics
- CPU interrupt reporting

### [Virtual](VIRTUAL.md) Machine Operation
- Update the Virtual Machine configuration to use os.009/os.dsk as the diskette image.
- Start the Virtual Machine.

<img src="../images/os009_VirtualBox_001.PNG" width="640"/>

### [Physical](PHYSICAL.md) Machine Operation
- Overwrite os.com on the OS boot diskette with os.009/os.com.
- Insert the OS boot diskette into the physical system's floppy disk drive A:.
- Start the system.

<img src="../images/os009_Boot_001.jpg"/>

### Notes

Project os.009 provides a ReportInterrupt function to capture register values at the time of a CPU interrupt and display them to the screen. For now the OS does not recover from CPU interrupts. We begin by defining some extended ASCII border values that will provide textual graphic border to our register values display.
```
EASCIIBORDSGLVERT       equ     0B3h                                            ;vertical single border
EASCIIBORDSGLUPRRGT     equ     0BFh                                            ;upper-right single border
EASCIIBORDSGLLWRLFT     equ     0C0h                                            ;lower-left single border
EASCIIBORDSGLHORZ       equ     0C4h                                            ;horizontal single border
EASCIIBORDSGLLWRRGT     equ     0D9h                                            ;lower-right single border
EASCIIBORDSGLUPRLFT     equ     0DAh                                            ;upper-left single border
```
Next, we've updated the 32 CPU interrupt handlers to store an interrupt number and a message offset address on the stack before jumping to the ReportInterrupt routine.
```
;=======================================================================================================================
;
;       CPU Interrupt Handlers
;
;       The first 32 entries in the Interrupt Descriptor Table are reserved for use by CPU interrupts. The handling
;       of these interrupts is expanded here to display the contents of registers at the time of the interrupt.
;
;=======================================================================================================================
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT0    Divide By Zero
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  dividebyzero                                    ;divide by zero
                        push    0                                               ;store interrupt nbr
                        push    czIntDivideByZero                               ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT1    Single Step
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  singlestep                                      ;single step
                        push    1                                               ;store interrupt nbr
                        push    czIntSingleStep                                 ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT2    Non-Maskable Interrupt
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  nmi                                             ;non-maskable
                        push    2                                               ;store interrupt nbr
                        push    czIntNonMaskable                                ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT3    Break
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  break                                           ;break
                        push    3                                               ;store interrupt nbr
                        push    czIntBreak                                      ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT4    Into
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  into                                            ;into
                        push    4                                               ;store interrupt nbr
                        push    czIntInto                                       ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT5    Bounds
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  bounds                                          ;bounds
                        push    5                                               ;store interrupt nbr
                        push    czIntBounds                                     ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT6    Bad Operation Code
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  badopcode                                       ;bad opcode interrupt
                        push    6                                               ;store interrupt nbr
                        push    czIntBadOpCode                                  ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT7    No Coprocessor
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  nocoproc                                        ;no coprocessor interrupt
                        push    7                                               ;store interrupt nbr
                        push    czIntNoCoprocessor                              ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT8    Double Fault
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  doublefault                                     ;doublefault interrupt
                        push    8                                               ;store interrupt nbr
                        push    czIntDoubleFault                                ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT9    Operand
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  operand                                         ;operand interrupt
                        push    9                                               ;store interrupt nbr
                        push    czIntOperand                                    ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT10   Bad Task State Segment
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  badtss                                          ;bad TSS interrupt
                        push    10                                              ;store interrupt nbr
                        push    czIntBadTSS                                     ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT11   Not Present
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  notpresent                                      ;not present interrupt
                        push    11                                              ;store interrupt nbr
                        push    czIntNotPresent                                 ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT12   Stack Limit
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  stacklimit                                      ;stack limit interrupt
                        push    12                                              ;store interrupt nbr
                        push    czIntStackLimit                                 ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT13   General Protection Fault
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  protection                                      ;protection fault interrupt
                        push    13                                              ;store interrupt nbr
                        push    czIntProtection                                 ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT14   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int14                                           ;(reserved)
                        push    14                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT15   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int15                                           ;(reserved)
                        push    15                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT16   Coprocessor Calculation
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  coproccalc                                      ;coprocessor calculation
                        push    16                                              ;store interrupt nbr
                        push    czIntCoprocessorCalc                            ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT17   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int17                                           ;(reserved)
                        push    17                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT18   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int18                                           ;(reserved)
                        push    18                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT19   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int19                                           ;(reserved)
                        push    19                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT20   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int20                                           ;(reserved)
                        push    20                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT21   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int21                                           ;(reserved)
                        push    21                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT22   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int22                                           ;(reserved)
                        push    22                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT23   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int23                                           ;(reserved)
                        push    23                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT24   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int24                                           ;(reserved)
                        push    24                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT25   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int25                                           ;(reserved)
                        push    25                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT26   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int26                                           ;(reserved)
                        push    26                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT27   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int27                                           ;(reserved)
                        push    27                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT28   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int28                                           ;(reserved)
                        push    28                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT29   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int29                                           ;(reserved)
                        push    29                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT30   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int30                                           ;(reserved)
                        push    30                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       INT31   Reserved
;
;-----------------------------------------------------------------------------------------------------------------------
                        menter  int31                                           ;(reserved)
                        push    31                                              ;store interrupt nbr
                        push    czIntReserved                                   ;store message offset
                        jmp     ReportInterrupt                                 ;report interrupt
```
Next, we update the ReportInterrupt routine to format and display a message showing the value of the registers at the tiem of the interrupt.
```
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        ReportInterrupt
;
;       Description:    This routine will be used to respond to processor interrupts that are not otherwise handled.
;                       At this stage, we simply restore the stack and return from the interrupt.
;
;       In:             [ESP+16]        EFLAGS                                  stored by interrupt call
;                       [ESP+12]        CS                                      stored by interrupt call
;                       [ESP+8]         EIP                                     stored by interrupt call
;                       [ESP+4]         interrupt number (0-31)                 stored by push instruction
;                       [ESP+0]         error message address                   stored by push instructions
;
;       Out:            N/A             This routine does not exit.
;
;-----------------------------------------------------------------------------------------------------------------------
ReportInterrupt         push    ds                                              ;save DS at time of interrupt
                        push    es                                              ;save ES at time of interrupt
                        pushad                                                  ;save EAX,ECX,EDX,EBX,EBP,ESP,ESI,EDI
                        mov     ebp,esp                                         ;EBP --> [EDI]
;
;       Addressability to registers at the time of the interrupt is now established as:
;
;                       [EBP+56]        EFLAGS
;                       [EBP+52]        CS
;                       [EBP+48]        EIP
;                       [EBP+44]        interrupt number (0-31)
;                       [EBP+40]        error message address
;                       [EBP+36]        DS
;                       [EBP+32]        ES
;                       [EBP+28]        EAX
;                       [EBP+24]        ECX
;                       [EBP+20]        EDX
;                       [EBP+16]        EBX
;                       [EBP+12]        ESP
;                       [EBP+8]         EBP
;                       [EBP+4]         ESI
;                       [EBP+0]         EDI
;
                        push    cs                                              ;load code selector ...
                        pop     ds                                              ;... into DS
                        push    EGDTCGA                                         ;load CGA memory selector ...
                        pop     es                                              ;... into ES
;
;       Display the interrupt report boundary box.
;
                        mov     cl,13                                           ;column
                        mov     ch,6                                            ;row
                        mov     dl,50                                           ;width
                        mov     dh,8                                            ;height
                        mov     bh,07h                                          ;attribute
                        call    DrawTextDialogBox                               ;draw text dialog box
;
;       Display the report header.
;
                        mov     cl,15                                           ;column
                        mov     ch,7                                            ;row
                        mov     esi,czIntHeader                                 ;interrupt message header
                        call    SetConsoleString                                ;draw text string
;
;       Display the interrupt description label.
;
                        mov     cl,15                                           ;column
                        mov     ch,8                                            ;row
                        mov     esi,czIntLabel                                  ;interrupt message description lead
                        call    SetConsoleString                                ;draw text string
;
;       Display the interrupt number.
;
                        mov     eax,[ebp+44]                                    ;interrupt number
                        mov     cl,26                                           ;column
                        mov     ch,8                                            ;row
                        call    PutConsoleHexByte                               ;draw ASCII hex byte
;
;       Display the interrupt name.
;
                        mov     cl,29                                           ;column
                        mov     ch,8                                            ;row
                        mov     esi,[ebp+40]                                    ;interrupt-specific message
                        call    SetConsoleString                                ;display interrupt description
;
;       Display the register values header.
;
                        mov     cl,15                                           ;column
                        mov     ch,10                                           ;row
                        mov     esi,czIntRegsHeader                             ;interrupt registers header
                        call    SetConsoleString                                ;draw text string
;
;       Display the EAX register label and value.
;
                        mov     cl,15                                           ;column
                        mov     ch,11                                           ;row
                        mov     esi,czIntEAX                                    ;register EAX label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+28]                                    ;EAX value at interrupt
                        mov     cl,19                                           ;column
                        mov     ch,11                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the ECX register label and value.
;
                        mov     cl,15                                           ;column
                        mov     ch,12                                           ;row
                        mov     esi,czIntECX                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+24]                                    ;ECX value at interrupt
                        mov     cl,19                                           ;column
                        mov     ch,12                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the EDX register label and value.
;
                        mov     cl,15                                           ;column
                        mov     ch,13                                           ;row
                        mov     esi,czIntEDX                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+20]                                    ;EDX value at interrupt
                        mov     cl,19                                           ;column
                        mov     ch,13                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the EBX register label and value.
;
                        mov     cl,15                                           ;column
                        mov     ch,14                                           ;row
                        mov     esi,czIntEBX                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+16]                                    ;EBX value at interrupt
                        mov     cl,19                                           ;column
                        mov     ch,14                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the ESI register label and value.
;
                        mov     cl,29                                           ;column
                        mov     ch,11                                           ;row
                        mov     esi,czIntESI                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+4]                                     ;ESI
                        mov     cl,33                                           ;column
                        mov     ch,11                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the EDI register label and value.
;
                        mov     cl,29                                           ;column
                        mov     ch,12                                           ;row
                        mov     esi,czIntEDI                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+0]                                     ;EDI
                        mov     cl,33                                           ;column
                        mov     ch,12                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the EBP register label and value.
;
                        mov     cl,29                                           ;column
                        mov     ch,13                                           ;row
                        mov     esi,czIntEBP                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+8]                                     ;EBP
                        mov     cl,33                                           ;column
                        mov     ch,13                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the DS register label and value.
;
                        mov     cl,42                                           ;column
                        mov     ch,11                                           ;row
                        mov     esi,czIntDS                                     ;label
                        call    SetConsoleString                                ;draw label
                        xor     eax,eax                                         ;zero register
                        mov     ax,[ebp+36]                                     ;DS
                        mov     cl,46                                           ;column
                        mov     ch,11                                           ;row
                        call    PutConsoleHexWord                               ;draw ASCII hex word
;
;       Display the ES register label and value.
;
                        mov     cl,42                                           ;column
                        mov     ch,12                                           ;row
                        mov     esi,czIntES                                     ;label
                        call    SetConsoleString                                ;draw label
                        xor     eax,eax                                         ;zero register
                        mov     ax,[ebp+32]                                     ;ES
                        mov     cl,46                                           ;column
                        mov     ch,12                                           ;row
                        call    PutConsoleHexWord                               ;draw ASCII hex word
;
;       Display the SS register label and value.
;
                        mov     cl,42                                           ;column
                        mov     ch,13                                           ;row
                        mov     esi,czIntSS                                     ;label
                        call    SetConsoleString                                ;draw label
                        xor     eax,eax                                         ;zero register
                        mov     ax,ss                                           ;SS
                        mov     cl,46                                           ;column
                        mov     ch,13                                           ;row
                        call    PutConsoleHexWord                               ;draw ASCII hex word
;
;       Display the CS register lable and value.
;
                        mov     cl,42                                           ;column
                        mov     ch,14                                           ;row
                        mov     esi,czIntCS                                     ;label
                        call    SetConsoleString                                ;draw label
                        xor     eax,eax                                         ;zero register
                        mov     ax,[ebp+52]                                     ;CS
                        mov     cl,46                                           ;column
                        mov     ch,14                                           ;row
                        call    PutConsoleHexWord                               ;draw ASCII hex word
;
;       Display the EFLAGS register label and value.
;
                        mov     cl,51                                           ;column
                        mov     ch,11                                           ;row
                        mov     esi,czIntEFLAGS                                 ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+56]                                    ;EFLAGS
                        mov     cl,55                                           ;column
                        mov     ch,11                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the ESP register label and value.
;
                        mov     cl,51                                           ;column
                        mov     ch,13                                           ;row
                        mov     esi,czIntESP                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+12]                                    ;ESP
                        mov     cl,55                                           ;column
                        mov     ch,13                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Display the EIP register label and value.
;
                        mov     cl,51                                           ;column
                        mov     ch,14                                           ;row
                        mov     esi,czIntEIP                                    ;label
                        call    SetConsoleString                                ;draw label
                        mov     eax,[ebp+48]                                    ;EIP lo-order 32-bits
                        mov     cl,55                                           ;column
                        mov     ch,14                                           ;row
                        call    PutConsoleHexDword                              ;draw ASCII hex doubleword
;
;       Halt and loop until reset.
;
.10                     sti                                                     ;enable maskable interrupts
                        hlt                                                     ;halt processor
                        jmp     .10                                             ;resume on interrupt
;-----------------------------------------------------------------------------------------------------------------------
;
;       Processor Interrupt Name Strings
;
;-----------------------------------------------------------------------------------------------------------------------
czIntDivideByZero       db      "Division by zero",0
czIntSingleStep         db      "Single step",0
czIntNonMaskable        db      "Non-maskable interrupt",0
czIntBreak              db      "Break",0
czIntInto               db      "Into",0
czIntBounds             db      "Bounds",0
czIntBadOpCode          db      "Bad Operation Code",0
czIntNoCoprocessor      db      "No Coprocessor",0
czIntDoubleFault        db      "Double Fault",0
czIntOperand            db      "Operand",0
czIntBadTSS             db      "Bad Task State Segment",0
czIntNotPresent         db      "Not Present",0
czIntStackLimit         db      "Stack Limit",0
czIntProtection         db      "General Protection Fault",0
czIntCoprocessorCalc    db      "Coprocessor Calculation",0
czIntReserved           db      "Reserved",0
;-----------------------------------------------------------------------------------------------------------------------
;
;       Processor Interrupt Handling Strings
;
;-----------------------------------------------------------------------------------------------------------------------
czIntHeader             db      "An unhandled processor interrupt has occurred:",0
czIntLabel              db      "Interrupt #",0
czIntRegsHeader         db      "Registers at the time of the interrupt:",0
czIntEAX                db      "EAX:",0
czIntECX                db      "ECX:",0
czIntEDX                db      "EDX:",0
czIntEBX                db      "EBX:",0
czIntESI                db      "ESI:",0
czIntEDI                db      "EDI:",0
czIntEBP                db      "EBP:",0
czIntESP                db      "ESP:",0
czIntDS                 db      " DS:",0
czIntES                 db      " ES:",0
czIntSS                 db      " SS:",0
czIntCS                 db      " CS:",0
czIntEFLAGS             db      "FLG:",0
czIntEIP                db      "EIP:",0
```
The DrawTextDialogBox routine is called to draw the ASCII text border.
```
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        DrawTextDialogBox
;
;       Description:    This routine opens a text-mode dialog box with an ASCII border.
;
;       In:             CL      upper left column (0-79)
;                       CH      upper left row (0-24)
;                       DL      column width, excluding border
;                       DH      row height, excluding border
;                       BH      color attribute
;
;-----------------------------------------------------------------------------------------------------------------------
DrawTextDialogBox       push    ecx                                             ;save non-volatile regs
                        push    esi                                             ;
                        push    edi                                             ;
                        push    es                                              ;
                        push    EGDTCGA                                         ;load CGA selector ...
                        pop     es                                              ;... into ES
;
;       Compute target display offset.
;
                        xor     eax,eax                                         ;zero register
                        mov     al,ch                                           ;row
                        mov     ah,ECONROWBYTES                                 ;mulitplicand
                        mul     ah                                              ;row offset
                        add     al,cl                                           ;add column
                        adc     ah,0                                            ;add overflow
                        add     al,cl                                           ;add column
                        adc     ah,0                                            ;add overflow
                        mov     edi,eax                                         ;target row offset
;
;       Display top border row.
;
                        push    edi                                             ;save target row offset
                        mov     ah,bh                                           ;attribute
                        mov     al,EASCIIBORDSGLUPRLFT                          ;upper-left single border
                        stosw                                                   ;display character and attribute
                        mov     al,EASCIIBORDSGLHORZ                            ;horizontal single border
                        xor     ecx,ecx                                         ;zero register
                        mov     cl,dl                                           ;width, excluding border
                        rep     stosw                                           ;display horizontal border
                        mov     al,EASCIIBORDSGLUPRRGT                          ;upper-right single border
                        stosw                                                   ;display character and attribute
                        pop     edi                                             ;restore target row offset
                        add     edi,ECONROWBYTES                                ;next row
;
;       Display dialog box body rows.
;
                        xor     ecx,ecx                                         ;zero register
                        mov     cl,dh                                           ;height, excluding border
.10                     push    ecx                                             ;save remaining rows
                        push    edi                                             ;save target row offset
                        mov     ah,bh                                           ;attribute
                        mov     al,EASCIIBORDSGLVERT                            ;vertical single border
                        stosw                                                   ;display character and attribute
                        mov     al,EASCIISPACE                                  ;space
                        xor     ecx,ecx                                         ;zero register
                        mov     cl,dl                                           ;width, excluding border
                        rep     stosw                                           ;display row
                        mov     al,EASCIIBORDSGLVERT                            ;vertical single border
                        stosw                                                   ;display character and attribute
                        pop     edi                                             ;restore target row offset
                        add     edi,ECONROWBYTES                                ;next row
                        pop     ecx                                             ;remaining rows
                        loop    .10                                             ;next row
;
;       Display bottom border row.
;
                        push    edi                                             ;save target row offset
                        mov     ah,bh                                           ;attribute
                        mov     al,EASCIIBORDSGLLWRLFT                          ;lower-left single border
                        stosw                                                   ;display character and attribute
                        mov     al,EASCIIBORDSGLHORZ                            ;horizontal single border
                        xor     ecx,ecx                                         ;zero register
                        mov     cl,dl                                           ;width, excluding border
                        rep     stosw                                           ;display horizontal border
                        mov     al,EASCIIBORDSGLLWRRGT                          ;lower-right single border
                        stosw                                                   ;display character and attribute
                        pop     edi                                             ;restore target row offset
                        add     edi,ECONROWBYTES                                ;next row
;
;       Restore and return.
;
                        pop     es                                              ;restore non-volatile regs
                        pop     edi                                             ;
                        pop     esi                                             ;
                        pop     ecx                                             ;
                        ret                                                     ;return
```
Two new kernel routines are added to help convert 16 and 32-bit binary values to hexadecimal ASCII character representations.
```
;=======================================================================================================================
;
;       Console Helper Routines
;
;       GetConsoleMessage
;       PutConsoleHexByte
;       PutConsoleHexDword
;       PutConsoleHexWord
;       PutConsoleOIA
;       Yield
;
;=======================================================================================================================
```
```
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        PutConsoleHexDword
;
;       Description:    This routine writes eight ASCII characters to the console representing a doubleword value.
;
;       In:             EAX     value
;                       CL      column
;                       CH      row
;                       DS      OS data selector
;                       ES      CGA selector
;
;-----------------------------------------------------------------------------------------------------------------------
PutConsoleHexDword      push    eax                                             ;save value
                        shr     eax,16                                          ;high-order word
                        call    PutConsoleHexWord                               ;display high-order word
                        pop     eax                                             ;restore value
                        call    PutConsoleHexWord                               ;display low-order word
                        ret                                                     ;return
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        PutConsoleHexWord
;
;       Description:    This routine writes four ASCII characters to the console representing a word value.
;
;       In:             EAX     value
;                       CL      column
;                       CH      row
;                       DS      OS data selector
;                       ES      CGA selector
;
;-----------------------------------------------------------------------------------------------------------------------
PutConsoleHexWord       push    eax                                             ;save value
                        shr     eax,8                                           ;high-order byte
                        call    PutConsoleHexByte                               ;display high-order byte
                        pop     eax                                             ;restore value
                        call    PutConsoleHexByte                               ;display low-order byte
                        ret                                                     ;return
```
The SetConsolString routine is added to call SetConsoleChar in series for a character string.
```
;=======================================================================================================================
;
;       Memory-Mapped Video Routines
;
;       These routines read and/or write directly to CGA video memory (B800:0)
;
;       SetConsoleChar
;       SetConsoleString
;
;=======================================================================================================================
```
```
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        SetConsoleString
;
;       Description:    This routine outputs a sequence of ASCII character at the given row and column.
;
;       In:             ESI     source offset (DS:)
;                       CL      column
;                       CH      row
;                       ES      CGA selector
;
;-----------------------------------------------------------------------------------------------------------------------
SetConsoleString        push    esi                                             ;save non-volatile regs
                        cld                                                     ;forward strings
.10                     lodsb                                                   ;next ASCII character
                        test    al,al                                           ;end of string?
                        jz      .20                                             ;yes, branch
                        call    SetConsoleChar                                  ;store character
                        jmp     .10                                             ;continue
.20                     pop     esi                                             ;restore non-volatile regs
                        ret                                                     ;return
```
Finally, in the console task, the ConInt6 routine is added to issue a known bad opcode (udp2) to trigger the CPU interrupt 6. This command name and its offset address are added to the command tables.
```
;-----------------------------------------------------------------------------------------------------------------------
;
;       Routine:        ConInt6
;
;       Description:    This routine issues an interrupt 6 to exercise the interrupt handler.
;
;-----------------------------------------------------------------------------------------------------------------------
ConInt6                 ud2                                                     ;raise bad opcode exception
                        ret                                                     ;return (not executed)
```
```
                                                                                ;---------------------------------------
                                                                                ;  Command Jump Table
                                                                                ;---------------------------------------
tConJmpTbl              equ     $                                               ;command jump table
                        dd      ConReset        - ConCode                       ;reset command
                        dd      ConInt6         - ConCode                       ;int6 command
ECONJMPTBLL             equ     ($-tConJmpTbl)                                  ;table length
ECONJMPTBLCNT           equ     ECONJMPTBLL/4                                   ;table entries
                                                                                ;---------------------------------------
                                                                                ;  Command Name Table
                                                                                ;---------------------------------------
tConCmdTbl              equ     $                                               ;command name table
                        db      2,"R",0                                         ;reset command
                        db      5,"INT6",0                                      ;int6 command
                        db      0                                               ;end of table
```
